name: Mermaid â†’ PNG (No Browser)

on:
  push:
    paths:
      - "diagrams/**.mmd"
      - ".github/scripts/**"
      - "package.json"
      - "package-lock.json"
  pull_request:
    paths:
      - "diagrams/**.mmd"
      - ".github/scripts/**"
      - "package.json"
      - "package-lock.json"
  workflow_dispatch:
    inputs:
      input_pattern:
        description: "Glob pattern for Mermaid files"
        default: "diagrams/**/*.mmd"
        required: true
      output_dir:
        description: "Output directory for PNGs"
        default: "diagrams"
        required: true
      theme:
        description: "Mermaid theme (default, neutral, forest, dark, base)"
        default: "default"
        required: false

jobs:
  render:
    name: Render Mermaid to PNG (No Browser)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: mermaid-png-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci || npm install

      - name: Render to PNG (no browser)
        env:
          INPUT_PATTERN: ${{ github.event.inputs.input_pattern || 'diagrams/**/*.mmd' }}
          OUTPUT_DIR:    ${{ github.event.inputs.output_dir    || 'diagrams' }}
          MERMAID_THEME: ${{ github.event.inputs.theme         || 'default' }}
        run: |
          node .github/scripts/mermaid-to-png.mjs

      - name: Upload PNGs
        uses: actions/upload-artifact@v4
        with:
          name: mermaid-pngs
          path: |
            diagrams/**/*.png
            !**/node_modules/**
          if-no-files-found: warn
